"use client";

import { useState, useEffect, useRef } from "react";
import { useRouter } from "next/navigation";
import { onAuthStateChanged, User } from "firebase/auth";
import { doc, getDoc } from "firebase/firestore";
import { auth, db } from "@/lib/firebase";
import AuthGuard from "@/components/AuthGuard";
import Header from "@/components/Header";
import { getPayjpPublicKey } from "@/lib/payjp";

interface CardData {
  brand: string;
  last4: string;
  exp_month: number;
  exp_year: number;
}

export default function PaymentPage() {
  const router = useRouter();
  const [user, setUser] = useState<User | null>(null);
  const [cardData, setCardData] = useState<CardData | null>(null);
  const [loading, setLoading] = useState(true);
  const [processing, setProcessing] = useState(false);
  const [message, setMessage] = useState<{ type: "success" | "error"; text: string } | null>(null);
  const [payjpLoaded, setPayjpLoaded] = useState(false);
  const [showCardForm, setShowCardForm] = useState(false);
  const paymentFormRef = useRef<any>(null);
  const widgetsRef = useRef<any>(null);

  useEffect(() => {
    if (!auth || !db) return;

    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      if (currentUser) {
        setUser(currentUser);
        await loadCardData(currentUser);
      }
      setLoading(false);
    });

    return () => unsubscribe();
  }, []);

  // Pay.jp payments.jsスクリプトを動的に読み込む
  useEffect(() => {
    if (typeof window === "undefined") return;

    // すでに読み込まれているかチェック
    if ((window as any).PayjpPayments) {
      console.log("Pay.jp Payments already loaded");
      setPayjpLoaded(true);
      return;
    }

    // payments.js スクリプトタグを作成
    const script = document.createElement("script");
    script.src = "https://js.pay.jp/payments.js";
    script.async = true;
    script.onload = () => {
      console.log("Pay.jp Payments script loaded successfully");
      if ((window as any).PayjpPayments) {
        setPayjpLoaded(true);
      } else {
        console.error("PayjpPayments object not found after script load");
        setMessage({ type: "error", text: "Pay.jpの初期化に失敗しました" });
      }
    };
    script.onerror = (error) => {
      console.error("Failed to load Pay.jp Payments script:", error);
      setMessage({ type: "error", text: "Pay.jpの読み込みに失敗しました" });
    };

    document.body.appendChild(script);

    return () => {
      // クリーンアップ: スクリプトタグを削除
      if (script.parentNode) {
        script.parentNode.removeChild(script);
      }
    };
  }, []);

  // リダイレクト後のSetup Flow完了確認
  useEffect(() => {
    const checkSetupCompletion = async () => {
      if (!user || !payjpLoaded || typeof window === "undefined") return;

      const urlParams = new URLSearchParams(window.location.search);
      const setupFlowClientSecret = urlParams.get("setup_flow_client_secret");
      
      if (!setupFlowClientSecret) return;

      console.log("Setup Flow completion detected, client_secret:", setupFlowClientSecret);
      setProcessing(true);

      try {
        // Setup Flowのステータスを確認
        const payments = (window as any).PayjpPayments(getPayjpPublicKey());
        const setupFlow = await payments.retrieveSetupFlow(setupFlowClientSecret);
        
        console.log("Setup Flow retrieved:", setupFlow);
        console.log("Setup Flow JSON:", JSON.stringify(setupFlow, null, 2));

        if (setupFlow.status === "succeeded") {
          const paymentMethodId = setupFlow.payment_method_id;
          console.log("Registration succeeded, payment_method_id:", paymentMethodId);

          if (!paymentMethodId) {
            throw new Error("payment_method_id が取得できませんでした。Setup Flow オブジェクトを確認してください。");
          }

          // バックエンドにpayment_method_idを保存
          const response = await fetch("/api/payjp/save-payment-method", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userId: user.uid,
              paymentMethodId,
            }),
          });

          if (!response.ok) {
            throw new Error("支払い方法の保存に失敗しました");
          }

          setMessage({ type: "success", text: "クレジットカードを登録しました！" });
          await loadCardData(user);

          // URLパラメータをクリア
          window.history.replaceState({}, "", "/mypage/payment");
        } else {
          console.error("Setup Flow status is not succeeded:", setupFlow.status);
          setMessage({ type: "error", text: "カード登録に失敗しました" });
        }
      } catch (error: any) {
        console.error("Setup completion error:", error);
        setMessage({ type: "error", text: "エラーが発生しました: " + error.message });
      } finally {
        setProcessing(false);
      }
    };

    checkSetupCompletion();
  }, [user, payjpLoaded]);

  const loadCardData = async (currentUser: User) => {
    if (!db) return;

    try {
      const userDocRef = doc(db, "users", currentUser.uid);
      const userDoc = await getDoc(userDocRef);
      
      if (userDoc.exists()) {
        const userData = userDoc.data();
        
        // payjpPaymentMethodId があればカードが登録されている
        if (userData.payjpPaymentMethodId) {
          // TODO: バックエンド経由で Pay.jp API から実際のカード情報を取得
          // 今は仮のデータを表示
          setCardData({
            brand: "Card",
            last4: "••••",
            exp_month: 12,
            exp_year: 2025,
          });
        }
      }
    } catch (error) {
      console.error("Error loading card data:", error);
    }
  };

  const handleAddCard = async () => {
    if (!user) {
      setMessage({ type: "error", text: "ログインしてください" });
      return;
    }

    if (!payjpLoaded || typeof window === "undefined" || !(window as any).PayjpPayments) {
      console.error("Pay.jp check failed:", { payjpLoaded, PayjpPayments: (window as any)?.PayjpPayments });
      setMessage({ type: "error", text: "Pay.jpの読み込みに失敗しました" });
      return;
    }

    setProcessing(true);
    setMessage(null);

    try {
      const publicKey = getPayjpPublicKey();
      
      if (!publicKey) {
        setMessage({ type: "error", text: "Pay.jpの公開鍵が設定されていません" });
        setProcessing(false);
        return;
      }

      console.log("Creating Setup Flow...");
      
      // バックエンドでSetup Flowを作成
      const response = await fetch("/api/payjp/create-setup-flow", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: user.uid }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: response.statusText }));
        console.error("Setup Flow creation failed:", errorData);
        throw new Error(`Setup Flowの作成に失敗しました: ${errorData.error || response.statusText}`);
      }

      const { client_secret } = await response.json();
      console.log("Setup Flow created, client_secret:", client_secret);
      
      // Pay.jp Paymentsを初期化
      const payments = (window as any).PayjpPayments(publicKey);
      console.log("Payments initialized:", !!payments);
      
      // Widgetsを作成
      const widgets = payments.widgets({
        clientSecret: client_secret,
      });
      console.log("Widgets created:", !!widgets);
      
      widgetsRef.current = widgets;
      console.log("widgetsRef.current (widgets) set:", !!widgetsRef.current);
      
      // カード入力フォームを表示
      setShowCardForm(true);
      
      // 少し待ってからフォームをマウント
      setTimeout(() => {
        console.log("Creating payment form from widgets...");
        
        try {
          // フォームを作成
          const paymentForm = widgets.createForm("payment", {
            layout: "tab",
          });
          console.log("Payment form created:", !!paymentForm);
          
          paymentFormRef.current = paymentForm;
          
          // フォームをマウント
          paymentForm.mount('#card-form');
          console.log("Payment form mounted successfully to #card-form");
          setProcessing(false);
        } catch (mountError: any) {
          console.error("Form creation/mount error:", mountError);
          setMessage({ type: "error", text: "フォームの表示に失敗しました: " + mountError.message });
          setProcessing(false);
        }
      }, 100);
      
    } catch (error: any) {
      console.error("Setup Flow error:", error);
      setMessage({ type: "error", text: "エラーが発生しました: " + error.message });
      setProcessing(false);
    }
  };

  const handleConfirmCard = async () => {
    console.log("handleConfirmCard called");
    console.log("widgetsRef (widgets) exists:", !!widgetsRef.current);
    
    if (!widgetsRef.current) {
      console.error("widgetsRef.current (widgets) is null!");
      setMessage({ type: "error", text: "フォームが初期化されていません" });
      return;
    }

    setProcessing(true);
    setMessage(null);

    try {
      console.log("Calling confirmSetup on widgets...");
      const result = await widgetsRef.current.confirmSetup({
        return_url: `${window.location.origin}/mypage/payment`,
      });

      console.log("confirmSetup result:", result);

      if (result.error) {
        throw new Error(result.error.message);
      }

      // confirmSetup が成功すると return_url にリダイレクトされます
      // リダイレクト後の処理は上記の useEffect で実行されます
      console.log("Redirecting to return_url...");
    } catch (error: any) {
      console.error("Confirm setup error:", error);
      setMessage({ type: "error", text: "カード登録に失敗しました: " + error.message });
      setProcessing(false);
    }
  };

  const handleCancelCard = () => {
    setShowCardForm(false);
    setProcessing(false);
    
    // フォームをクリーンアップ
    if (paymentFormRef.current) {
      paymentFormRef.current.unmount();
      paymentFormRef.current = null;
    }
    widgetsRef.current = null;
  };

  const handleDeleteCard = async () => {
    if (!user || !confirm("登録済みのカード情報を削除しますか？")) {
      return;
    }

    setProcessing(true);
    setMessage(null);

    try {
      // TODO: カード削除API呼び出し
      // const response = await fetch("/api/payjp/delete-card", {
      // 仮の実装
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      setCardData(null);
      setMessage({ type: "success", text: "カード情報を削除しました" });
    } catch (error: any) {
      console.error("Delete card error:", error);
      setMessage({ type: "error", text: "削除に失敗しました: " + error.message });
    } finally {
      setProcessing(false);
    }
  };

  if (loading) {
    return (
      <AuthGuard>
        <div className="min-h-screen flex items-center justify-center">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p className="text-gray-600">読み込み中...</p>
          </div>
        </div>
      </AuthGuard>
    );
  }

  return (
    <AuthGuard>
      <div className="min-h-screen bg-gray-50">
        <Header />
        <main className="container mx-auto px-4 py-16">
          <div className="max-w-2xl mx-auto">
            <div className="mb-8">
              <button
                onClick={() => router.push("/mypage")}
                className="text-blue-600 hover:text-blue-800 text-sm font-medium mb-4"
              >
                ← マイページに戻る
              </button>
              <h1 className="text-3xl font-bold">クレジットカード管理</h1>
              <p className="text-gray-600 mt-2">
                サブスクリプション決済に使用するクレジットカード情報を管理します
              </p>
            </div>

            {message && (
              <div className={`mb-6 p-4 rounded ${
                message.type === "success" 
                  ? "bg-green-100 border border-green-400 text-green-700" 
                  : "bg-red-100 border border-red-400 text-red-700"
              }`}>
                {message.text}
              </div>
            )}

            <div className="bg-white rounded-lg shadow p-6">
              {cardData ? (
                <div>
                  <h2 className="text-xl font-semibold mb-4">登録済みカード情報</h2>
                  
                  <div className="bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg p-6 text-white mb-6">
                    <div className="flex justify-between items-start mb-8">
                      <div className="text-sm opacity-90">登録カード</div>
                      <div className="text-xl font-bold">{cardData.brand.toUpperCase()}</div>
                    </div>
                    <div className="text-2xl tracking-widest mb-6">
                      **** **** **** {cardData.last4}
                    </div>
                    <div className="flex justify-between text-sm">
                      <div>
                        <div className="opacity-70 text-xs mb-1">有効期限</div>
                        <div className="font-semibold">
                          {String(cardData.exp_month).padStart(2, "0")} / {cardData.exp_year}
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="space-y-3">
                    <button
                      onClick={handleAddCard}
                      disabled={processing}
                      className="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors font-medium"
                    >
                      {processing ? "処理中..." : "カードを変更"}
                    </button>
                    <button
                      onClick={handleDeleteCard}
                      disabled={processing}
                      className="w-full bg-red-600 text-white py-3 rounded-md hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors font-medium"
                    >
                      カード情報を削除
                    </button>
                  </div>
                </div>
              ) : (
                <div>
                  <h2 className="text-xl font-semibold mb-4">クレジットカード登録</h2>
                  <p className="text-gray-600 mb-6">
                    サブスクリプション決済にはクレジットカードの登録が必要です。
                    カード情報は安全に暗号化されて保存されます。
                  </p>

                  <div className="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 className="font-semibold mb-2">対応カードブランド</h3>
                    <div className="flex gap-4 text-sm text-gray-600">
                      <span>• Visa</span>
                      <span>• Mastercard</span>
                      <span>• JCB</span>
                      <span>• American Express</span>
                    </div>
                  </div>

                  {showCardForm ? (
                    <div>
                      {/* Pay.jpのカード入力フォーム */}
                      <div id="card-form" className="mb-6 min-h-[300px]"></div>
                      
                      <div className="space-y-3">
                        <button
                          onClick={handleConfirmCard}
                          disabled={processing}
                          className="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors font-medium"
                        >
                          {processing ? "登録中..." : "カードを登録"}
                        </button>
                        <button
                          onClick={handleCancelCard}
                          disabled={processing}
                          className="w-full bg-gray-500 text-white py-3 rounded-md hover:bg-gray-600 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors font-medium"
                        >
                          キャンセル
                        </button>
                      </div>
                    </div>
                  ) : (
                    <button
                      onClick={handleAddCard}
                      disabled={processing || !payjpLoaded}
                      className="w-full bg-blue-600 text-white py-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors font-semibold"
                    >
                      {processing ? "処理中..." : !payjpLoaded ? "読み込み中..." : "クレジットカードを登録"}
                    </button>
                  )}

                  <div className="mt-6 text-sm text-gray-500">
                    <p className="mb-2">セキュリティについて：</p>
                    <ul className="space-y-1 ml-4">
                      <li>• カード情報は直接サーバーに送信されません</li>
                      <li>• Pay.jpの安全な決済システムを使用しています</li>
                      <li>• PCI DSS準拠で最高レベルのセキュリティを実現</li>
                    </ul>
                  </div>
                </div>
              )}
            </div>
          </div>
        </main>
      </div>
    </AuthGuard>
  );
}
